<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AcademiaBach</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <style>


        .store {

            overflow-y: auto; 
            color: #000;
            font-family:  sans-serif; 
        }

        .item {
            background-color: #acc1e5;
            border: 1px solid #1b184f;
            text-align: center;
            color: #000;
          }





        .buy-button {
            background-color: #213953;
            color: #fff;
            padding: 1% 5%;
            border: none;
            cursor: pointer;
        }

        .mascotabar{
            width: 7%;
            background-color: #acc1e5;
            border: 1px solid #1b184f;
            padding: 0%;

            left: 78%;
            top: 7%;
            position: fixed;
            display: flex;
            justify-content: center;
            align-items: center;

            color: rgb(31, 39, 78);

        }

        .mascotabar img {
            width: 100%;
            height: auto;
        }



    


        @media screen and (max-width: 600px) {
            
            .item {
            background-color: #acc1e5;
            border: 1px solid #1b184f;

            }



            .buy-button {
                background-color: #213953;
                color: #fff;
                padding: 1% 5%;
                border: none;
                cursor: pointer;
            }



        }



            @media screen and (min-width: 601px) and (max-width: 1024px) {
  


            .item {
            background-color: #acc1e5;
            border: 1px solid #1b184f;
            text-align: center;

            }



            .buy-button {
                background-color: #213953;
                color: #fff;
                padding: 1% 5%;
                border: none;
                cursor: pointer;
            }




            }
  </style>
  </head>

  <body>
	<div class="d-flex flex-row min-vh-100">
		<div class="offcanvas offcanvas-start w-auto" id="navbarSupportedContent" style="background-color: #acc1e5;">
			<div class="offcanvas-header">
				<button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
			</div>

			<div class="offcanvas-body">
				<ul class="nav flex-column">
					<li class="nav-item">
						<a class="nav-link" aria-current="page" href="#" style="text-align:center" onclick="index()">
							<img src="/images/indexlogo.png" style="width: 100px;" >
						</a>
					</li>
                    <li class="nav-item">
						<a class="nav-link" aria-current="page" href="#" style="text-align:center" onclick="checklist()">
							<img src="/images/listaicono.png" style="width: 100px;" >
						</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" aria-current="page" href="#" style="text-align:center" onclick="papelera()">
							<img src="/images/papeleralogo.png" style="width: 100px;">
						</a>
					</li>

                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" href="#" style="text-align:center" onclick="mascota()">
                            <img src="/images/homeicono.png" style="width: 100px;">
                        </a>
                    </li>
					<li class="nav-item">
						<a class="nav-link" aria-current="page" href="#"  style="text-align:center" onclick="cementerio()">
							<img src="/images/Tumba.png" style="width: 100px;">
						</a>
					</li>
				</ul>
			</div>
		</div>

		<div class="offcanvas offcanvas-top" id="navbarSupportedContentTop" style="background-color: #acc1e5;">
			<div class="offcanvas-header">
				<button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
			</div>
			<div class="offcanvas-body">
				<ul class="nav flex-row">
                    <li class="nav-item"  style="margin-right: -2%; ">
						<a class="nav-link" aria-current="page" href="#" style="text-align:center" onclick="index()">
							<img src="/images/indexlogo.png" style="width: 55px;" >
						</a>
					</li>
                    <li class="nav-item" style="margin-right: -2%;">
                        <a class="nav-link" aria-current="page" href="#" style="text-align:center" onclick="checklist()">
                            <img src="/images/listaicono.png" style="width: 55px;">
                        </a>
                    </li>
					<li class="nav-item" style="margin-right: -2%; ">
						<a class="nav-link" aria-current="page" href="#" style="text-align:center" onclick="papelera()">
							<img src="/images/papeleralogo.png" style="width: 55px;">
						</a>
					</li>            

                    <li class="nav-item" style="margin-right: -2%;">
                        <a class="nav-link" aria-current="page" href="#" style="text-align:center" onclick="mascota()">
                            <img src="/images/homeicono.png" style="width: 55px;">
                        </a>
                    </li>
                <li class="nav-item">
                    <a class="nav-link" aria-current="page" href="#" style="text-align:center" onclick="cementerio()">
                        <img src="/images/Tumba.png" style="width: 60px;">
                    </a>
                </li>
				</ul>
			</div>
		</div>

        <div class="flex-grow-1 d-flex flex-lg-row flex-column" style="border:1px SOLID black;">
            <div class="p-2  flex-grow-1 d-flex flex-column  justify-content-start align-items-stretch"
                style="background-color:rgb(82,107,141); color:white">

                <div class="d-flex flex-row justify-content-between" style="width:100%;">
                    <a type="button" data-bs-toggle="offcanvas" data-bs-target="#navbarSupportedContent"
                        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"
                        class="d-none d-lg-block">
                        <img src="/images/logo.png" style="width: 100px;">
                    </a>

                    <a type="button" data-bs-toggle="offcanvas" data-bs-target="#navbarSupportedContentTop"
                        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"
                        class="d-lg-none">
                        <img src="/images/logo.png" style="width: 80px;">
                    </a>

                </div>
                <div class="container" style="margin-bottom: 50px;">
                    <div class="store row">
                        <div class="item col-xl-3 col-lg-4 col-md-6 col-12">
                            <img src="/images/1.1.png" alt="Producto 1">
                            <img class="segunda-imagen" src="/images/1.2.png" alt="Producto 1-2" style="display: none">
                            <p class="price " style="font-size: 30px;">0</p>
                            <input type="text" class="nuevaMascotaInput" placeholder="Nombre Mascota" required>
                            <button class="buy-button" onclick="comprar(1)">Comprar</button>
                        </div>
                         <div class="item col-xl-3 col-lg-4 col-md-6 col-12">
                            <img src="/images/3.1.png" alt="Producto 2">
                            <img class="segunda-imagen" src="/images/3.2.png" alt="Producto 2-2" style="display: none">
                            <p class="price" style="font-size: 30px;">10</p>
                            <input type="text" class="nuevaMascotaInput" placeholder="Nombre Mascota" required>
                            <button class="buy-button" onclick="comprar(2)">Comprar</button>
                        </div>
                        <div class="item col-xl-3 col-lg-4 col-md-6 col-12">
                            <img src="/images/2.1.png" alt="Producto 3">
                            <img class="segunda-imagen" src="/images/2.2.png" alt="Producto 3-2" style="display: none">
                            <p class="price" style="font-size: 30px;">10</p>
                            <input type="text" class="nuevaMascotaInput" placeholder="Nombre Mascota" required>
                            <button class="buy-button" onclick="comprar(3)">Comprar</button>
                        </div>
                        <div class="item col-xl-3 col-lg-4 col-md-6 col-12">
                            <img src="/images/5.1.png" alt="Producto 4">
                            <img class="segunda-imagen" src="/images/5.2.png" alt="Producto 4-2" style="display: none">
                            <p class="price" style="font-size: 30px;">15</p>
                            <input type="text" class="nuevaMascotaInput" placeholder="Nombre Mascota" required>
                            <button class="buy-button" onclick="comprar(4)">Comprar</button>
                        </div>
                        <div class="item col-xl-3 col-lg-4 col-md-6 col-12">
                            <img src="/images/6.1.png" alt="Producto 5">
                            <img class="segunda-imagen" src="/images/6.2.png" alt="Producto 6-2" style="display: none">
                            <p class="price" style="font-size: 30px;">15</p>
                            <input type="text" class="nuevaMascotaInput" placeholder="Nombre Mascota" required>
                            <button class="buy-button" onclick="comprar(5)">Comprar</button>
                        </div>
                        <div class="item col-xl-3 col-lg-4 col-md-6 col-12">
                            <img src="/images/7.1.png" alt="Producto 6">
                            <img class="segunda-imagen" src="/images/7.2.png" alt="Producto 7-2" style="display: none">
                            <p class="price" style="font-size: 30px;">35</p>
                            <input type="text" class="nuevaMascotaInput" placeholder="Nombre Mascota" required>
                            <button class="buy-button" onclick="comprar(6)">Comprar</button>
                        </div>
                        <div class="item col-xl-3 col-lg-4 col-md-6 col-12">
                            <img src="/images/4.1.png" alt="Producto 7">
                            <img class="segunda-imagen" src="/images/4.2.png" alt="Producto 8-2" style="display: none">
                            <p class="price" style="font-size: 30px;">35</p>
                            <input type="text" class="nuevaMascotaInput" placeholder="Nombre Mascota" required>
                            <button class="buy-button" onclick="comprar(7)">Comprar</button>
                        </div>
                        <div class="item col-xl-3 col-lg-4 col-md-6 col-12">
                            <img src="/images/8.1.png" alt="Producto 8">
                            <img class="segunda-imagen" src="/images/8.2.png" alt="Producto 9-2" style="display: none">
                            <p class="price" style="font-size: 30px;">35</p>
                            <input type="text" class="nuevaMascotaInput" placeholder="Nombre Mascota" required>
                            <button class="buy-button" onclick="comprar(8)">Comprar</button>
                        </div>
                        <div class="item col-xl-3 col-lg-4 col-md-6 col-12">
                            <img src="/images/9.1.png" alt="Producto 9">
                            <img class="segunda-imagen" src="/images/9.2.png" alt="Producto 10-2" style="display: none">
                            <p class="price" style="font-size: 30px;">50</p>
                            <input type="text" class="nuevaMascotaInput" placeholder="Nombre Mascota" required>
                            <button class="buy-button" onclick="comprar(9)">Comprar</button>
                        </div>
                        <div class="item col-xl-3 col-lg-4 col-md-6 col-12">
                            <img src="/images/10.1.png" alt="Producto 10">
                            <img class="segunda-imagen" src="/images/10.2.png" alt="Producto 11-2"
                                style="display: none">
                            <p class="price" style="font-size: 30px;">50</p>
                            <input type="text" class="nuevaMascotaInput" placeholder="Nombre Mascota" required>
                            <button class="buy-button" onclick="comprar(10)">Comprar</button>
                        </div>
                        <div class="item col-xl-3 col-lg-4 col-md-6 col-12">
                            <img src="/images/11.1.png" alt="Producto 11">
                            <img class="segunda-imagen" src="/images/11.2.png" alt="Producto 12-2"
                                style="display: none">
                            <p class="price" style="font-size: 30px;">75</p>
                            <input type="text" class="nuevaMascotaInput" placeholder="Nombre Mascota" required>
                            <button class="buy-button" onclick="comprar(11)">Comprar</button>
                        </div>
                        <div class="item col-xl-3 col-lg-4 col-md-6 col-12">
                            <img src="/images/12.1.png" alt="Producto 12">
                            <img class="segunda-imagen" src="/images/12.2.png" alt="Producto 13-2"
                                style="display: none">
                            <p class="price" style="font-size: 30px;">75</p>
                            <input type="text" class="nuevaMascotaInput" placeholder="Nombre Mascota" required>
                            <button class="buy-button" onclick="comprar(12)">Comprar</button>
                        </div>
                        <div class="item col-xl-3 col-lg-4 col-md-6 col-12">
                            <img src="/images/13.1.png" alt="Producto 13">
                            <img class="segunda-imagen" src="/images/13.2.png" alt="Producto 14-2"
                                style="display: none">
                            <p class="price" style="font-size: 30px;">100</p>
                            <input type="text" class="nuevaMascotaInput" placeholder="Nombre Mascota" required>
                            <button class="buy-button" onclick="comprar(13)">Comprar</button>
                        </div> 

                    </div>
                </div>

            </div>



        </div>



    </div>

    <div class="p-2 d-flex flex-lg-column  flex-row align-items-center"
    style="background-color: rgb(31, 39, 78); color:white; position: fixed; 
    bottom: 0;
    left: 0;
    right: 0;
    height: 50px;">
    <div>
        <h3 class="display-15" style="text-align:center">Puntos: <h id="puntosTotales">00</h>
        </h3>
    </div>
</div>
 

<script>
    var userId = '<%= user.id %>';
       // var listaLocal = JSON.parse(localStorage.getItem('storeElements')) || [];
        window.onload = function () {
            // Obtener la lista local
            //var listaLocal = JSON.parse(localStorage.getItem('storeElements')) || [];

            fetch('/' + userId +'/mascotas')
            .then(response => response.json())
            .then(data => {
                itemStore = 0;
                data.forEach(function (element) {
                    if (element.index > itemStore) {
                        itemStore = element.index;
                    }
                });
                console.log("Lista mascotas: ", data);
            })
            .catch(error => console.error('Error al obtener la lista de tareas:', error));

            // Establecer itemStore en función del índice más alto en la lista local


         };

         fetch(`/${userId}/puntos`)
            .then(response => {
                if (!response.ok) {
                throw new Error(`Error de red: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Datos de puntos:', data);
                if (data === null) {
                    data = 0;
                } else {
                    // Convertir a número si no es null
                    //data = parseInt(data, 10);

                   
                    if (data.length > 0) {
                        const idPuntos = data[0]._id;
                        console.log('ID de los puntos para el userId:', idPuntos);
                    } else {
                        if (data.length > 0) {
                        
                            fetch(`/${userId}/puntos`, {
                                method: 'POST', 
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                    body: JSON.stringify({
                                        userId: userId,
                                        puntosTotales: 0, 
                                    }),
                                })
                                .then(newResponse => {
                                    if (!newResponse.ok) {
                                         throw new Error(`Error al crear nuevos puntos: ${newResponse.status}`);
                                    }
                                        return newResponse.json();
                                })
                                .then(newData => {
                                        const newIdPuntos = newData._id;
                                        console.log('Se creó un nuevo conjunto de puntos. Nuevo ID:', newIdPuntos);

                                })
                                .catch(newError => {
                                        console.error('Error al crear nuevos puntos:', newError.message);

                                }); 
                            }
                    }  
                }
        
            })

            
        //localStorage.setItem('traspaso', false); //
        //var puntosTotalesGuardados = localStorage.getItem("puntosTotales"); ////

        fetch(`/${userId}/puntos`)
        .then(response => response.json())
        .then(data => {
            
            console.log('Lista de tareas:', data);
            if (data) {
            puntosTotales = data[0].puntosTotales;
            document.getElementById("puntosTotales").textContent = puntosTotales < 10 ? '0' + puntosTotales : puntosTotales;
            } else {
                puntosTotales = 0; 
            }
            
        })
        .catch(error => console.error('Error al obtener la lista de tareas:', error));




        var traspaso = true;
        //localStorage.setItem('traspaso', traspaso); //

        function comprar(item){
            //var puntosTotalesGuardados = localStorage.getItem("puntosTotales"); //
            fetch(`/${userId}/puntos`)
        .then(response => response.json())
        .then(puntosTotalesGuardados => {                  

            if (puntosTotalesGuardados) {
                puntosTotales = parseInt(puntosTotalesGuardados[0].puntosTotales, 10);
                document.getElementById("puntosTotales").textContent = puntosTotales < 10 ? '0' + puntosTotales : puntosTotales;
            } else {
                puntosTotales = 0;
            } 

            if (traspaso) {
                var precioElement = document.querySelector('.store .item:nth-child(' + item + ') .price');
                var precio = parseInt(precioElement.textContent, 10);

                if (puntosTotalesGuardados[0].puntosTotales >= precio) {
                    var nombreMascotaInput = document.querySelector('.store .item:nth-child(' + item + ') .nuevaMascotaInput');
                    var nombreMascota = nombreMascotaInput.value;
                    fetch('/' + userId +'/mascotas')
                    .then(response => response.json())
                    .then(data => {
       
                        var nombreRepetido = data.some(function (element) {
                        return element.nombre === nombreMascota;
                         });
                         
                    if (!nombreRepetido) {
                        var imagenMascotaDespierta = document.querySelector('.store .item:nth-child(' + item + ') img');
                        var imagenMascotaDormida = document.querySelector('.store .item:nth-child(' + item + ') .segunda-imagen');
                        var userId = '<%= user.id %>'
                        
                        var nuevoElemento = {
                            userId: userId,
                            imagenPrincipal: imagenMascotaDespierta.src,
                            segundaImagen: imagenMascotaDormida.src,
                            nombre: nombreMascota
                        };

                        //listaLocal.push(nuevoElemento);
                        let puntostotalesnuevo =  puntosTotalesGuardados[0].puntosTotales - precio;
                        console.log("Precios: " + precio);
                        console.log("Puntos totales nuevos: " + puntostotalesnuevo);

                        const idPuntos = puntosTotalesGuardados[0]._id;
                        if (!idPuntos) {
                                throw new Error('No se encontró un ID en los datos de puntos');
                        }

                        const dataToUpdate = {
                                userId: userId,
                                puntosTotales: puntostotalesnuevo ,
                        };
                                            
                        fetch(`/${userId}/puntos/${idPuntos}`, {
                                method: 'PUT',
                                headers: {
                                     'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(dataToUpdate),
                        })
                        .then(response => {
                                if (!response.ok) {
                                    throw new Error(`Error del servidor: ${response.status} - ${response.statusText}`);
                               }
                                    return response.json();
                        })
                        .then(updatedData => {
                                    console.log('Response JSON:', updatedData);
                    
                        })
                        .catch(error => {
                                    console.error('Error al realizar la solicitud:', error);
                        });

                        //puntosTotalesGuardados -= precio;
                        //localStorage.setItem("puntosTotales", puntosTotalesGuardados); //

                        //localStorage.setItem('storeElements', JSON.stringify(listaLocal));
                        fetch('/' + userId +'/mascotas', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(nuevoElemento),
                            })
                            .then(response => response.json())
                            .then(data => {
                                // Manejar la respuesta recibida después de guardar la tarea
                                console.log('Mascota guardada:', data);
                                // Aquí puedes realizar cualquier otra operación después de guardar la tarea
                            })
                            .catch(error => console.error('Error al guardar la tarea:', error));

                        traspaso = false;
                        //localStorage.setItem('traspaso', traspaso);

                        ;
                        window.location.href = "/mascota/" + userId;
                    } else {
                        alert("El nombre de la mascota ya existe.");
                        // Aquí puedes mostrar un mensaje de error o tomar alguna acción adecuada.
                    }
                    })
                    .catch(error => console.error('Error al obtener la lista de tareas:', error));

                    // Comprobar si el nombre de la mascota ya existe en la lista local
                 

                }
            }
            })
            .catch(error => console.error('Error al obtener la lista de tareas:', error));


        }











</script>


<script>


        function index(){
                var userId = '<%= user.id %>';
                window.location.href = "/"  + userId;
        
        }

         function checklist(){
        var userId = '<%= user.id %>';
        window.location.href = "/checklist/" + userId;

        }
	 
	 
		 function papelera(){
			 var userId = '<%= user.id %>';
			 window.location.href = "/papelera/" + userId;
	 
		 }
	 
	 
		 function cementerio(){
			 var userId = '<%= user.id %>';
		   window.location.href = "/cementerio/" + userId;
	 
		 }

         function mascota(){
            var userId = '<%= user.id %>';
            window.location.href = "/mascota/" + userId;

        }





</script>

    <!--  <h1>Hello, world!</h1> -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  </body>
</html>