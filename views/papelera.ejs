<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AcademiaBach</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <link rel="stylesheet" href="/bootstrap-datepicker-master/dist/css/bootstrap-datepicker.css">
    <script src="/bootstrap-datepicker-master/dist/js/bootstrap-datepicker.js"></script>




        <style>
      .sidebaror {
        position: relative;
          transition: 0.3s;
          display: flex;
          flex-direction: column;
          
      }

      .sidebaror img {
            width: 85%;
            height: auto;
            margin-top: 2.5%;
            }

     .sidebar {
          height: 150%;
          width: 9%;
          position: fixed;
          top: 0;
          left: -150%; 
          background-color: #acc1e5;
          transition: 0.3s;

      }

      .sidebar a {
          padding: 7%;
          text-decoration: none;
          font-size: 1vw;
          color: #1c4b6a;
          display: block;
      }

      .sidebar img {
      width: 100%;
      height: auto;

      }

      .sidebar a:hover {
          background-color: #acc1e5;
      }


      .content {
          margin-left: 5%;
          padding: 7%;
      }

      .content a img {
        position: fixed;
        left: 1%;
        top: 1%;
        width: 7%;
        height: auto;
        z-index: 3;
        }

        body {
        background-image: url('/images/Fondo3.png');  
        background-size: cover;               

        margin: 0;
        padding: 0;
        overflow: hidden; 
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        }

        main {
        display: flex;
        flex-direction: column;
        }

        header{
            background-color: rgb(31, 39, 78);
            color: white;
            text-align: center;
            padding: 0.5%;
        
        }

        footer {
            background-color: rgb(31, 39, 78);
            color: white;
            text-align: center;
            padding: 0.5%;
            margin-top: auto;
        }
            
            
        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between; 
        }
        

        .listaTareasEliminadas {
            background-color: rgb(163, 186, 217);
            width: 70%;
            max-height: 70vh; 
            overflow-y: auto; 
            height: 70vh;
            padding: 1.5%;
            border: 1px solid #ccc;
            position: fixed;
            top: 55%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            font-family: 'Arial', sans-serif; 
            font-size: 1vw;
            flex-direction: column;
            display: flex;
            
        }

        .listaTareasEliminadas li {
            list-style-type: none;
            display: flex;
            flex-direction: row; 
            align-items: center;
            background-color: white; 
            border: 1px solid #ccc; 
            padding: 0.5%;
        }



        .nuevaTarea {
            padding: 1%;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            width: 100%;
            left: 35%;
            top: 11%;
            transform: translate(-50%, -50%);
            font-family: 'Arial', sans-serif; 
            font-size: 1vw;
  
        }    


        .row {
            display: flex;
            align-items: center;
            background-color: #fff;

        }

        .col {
            padding: 10px;
            border: 1px solid #ccc;
            margin: 0% 0%;;
        }

        .col:last-child {
            margin-right: 0;
        }

        .flechavolver {
        width: 90%;
        position: fixed;
        display: flex;
        justify-content: center;
        align-items: center;
        top: 13%; 
        left: 23%; 
        transform: translate(-50%, -50%); 
        color: rgb(31, 39, 78);

        }

        .flechavolver img {
        width: 43%;
        height: auto;
        }


        .textoexplicativo {
            color: rgb(255, 255, 255);
            font-family: 'Arial', sans-serif; 
            font-size: 1.2vw;
            position: absolute;
            top: 91%;
            left: 48%;
                
        }

        .textoexplicativo2 {
            color: rgb(255, 255, 255);
            font-family: 'Arial', sans-serif; 
            font-size: 1.2vw;
            position: absolute;
            top: 94%;
            left: 48%;
                
        }

        .cerrar {
             position: fixed;
            display: flex;
            justify-content: center;
            align-items: center;
            top: 13%; 
            left: 91%; 
            transform: translate(-50%, -50%); 
            color: rgb(31, 39, 78);

        }

        .cerrar img {
            max-width: 60%;
            height: auto;
        }

        .nombreUsuario1 {
            font-size: 1.3vw;
            text-align: right;
            color: rgb(255, 255, 255);
            font-family: 'Arial', sans-serif; 
            background-color: rgb(31, 39, 78);
            z-index: 10;
            margin: 0;
        }

        @media screen and (max-width: 600px) {
                        
            .sidebaror {
                position: relative;
                transition: 0.3s;
                display: flex;
                flex-direction: row; 

            }

            .sidebar {
                height: 10%; 
                width: 90%; 
                position: fixed;
                top: 5.5%;
                left: -150%;
                background-color: #acc1e5;
                transition: 0.3s;
                display: flex; 
                flex-direction: row; 
                align-items: center; 
                font-size: 150%;

            }

            .sidebar a {
                padding: 1%; 
                text-decoration: none;
                font-size: 1vw;
                color: #1c4b6a;
                display: inline-block; 
            }

            .sidebar img {
                width: 50%;
                margin-left: 0;
            }

            .sidebar a:hover {
                background-color: #acc1e5;
            }

            .content a img {
                position: fixed;
                left: 1%;
                top: 4%;
                width: 12%;
                height: auto;
                z-index: 3;
            }

            header{
            background-color: rgb(31, 39, 78);
            color: white;
            text-align: center;
            padding: 2%;

            }

            footer {
            background-color: rgb(31, 39, 78);
            color: white;
            text-align: center;
            padding: 2%;
            margin-top: auto;
            }

            .listaTareasEliminadas {
            background-color: rgb(163, 186, 217);
            width: 70%;
            max-height: 60vh; 
            overflow-y: auto; 
            height: 60vh;
            padding: 1.5%;
            border: 1px solid #ccc;
            position: fixed;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%); 
            font-family: 'Arial', sans-serif; 
            font-size: 2.1vw;
            flex-direction: column;
            display: flex;
            
        }

        .listaTareasEliminadas li {
            list-style-type: none;
            display: flex;
            flex-direction: row; 
            align-items: center;
            background-color: white;
            border: 1px solid #ccc; 
            padding: 0.5%;
        } 

        .flechavolver {
        width: 60%;
        position: fixed;
        display: flex;
        justify-content: center;
        align-items: center;
        top: 25%; 
        left: 38%; 
        transform: translate(-50%, -50%); 
        color: rgb(31, 39, 78);

        }

        .flechavolver img {
        width: 33%;
        height: auto;
        }

        .nombreUsuario1 {
            font-size: 2.3vw;
            text-align: right;
            color: rgb(255, 255, 255);
            font-family: 'Arial', sans-serif; 
            background-color: rgb(31, 39, 78);
            z-index: 10;
            margin: 0;
            }


        .cerrar {
            position: fixed;
            display: flex;
            justify-content: center;
            align-items: center;
            top: 25%; 
            left: 85%; 
            transform: translate(-50%, -50%); 
            color: rgb(31, 39, 78);

            }

            .cerrar img {
            max-width: 85%;
            height: auto;
            }

            
        .textoexplicativo {
            color: rgb(255, 255, 255);
            font-family: 'Arial', sans-serif; 
            font-size: 2.1vw;
            position: absolute;
            top: 91%;
            left: 21%;
                
        }

        .textoexplicativo2 {
            color: rgb(255, 255, 255);
            font-family: 'Arial', sans-serif; 
            font-size: 2.1vw;
            position: absolute;
            top: 93%;
            left: 21%;
                
        }

    }



            @media screen and (min-width: 601px) and (max-width: 1024px) {
            .sidebaror {
                position: relative;
                transition: 0.3s;
                display: flex;
                flex-direction: column;
                
            }

            .sidebaror img {
                    width: 95%;
                    height: auto;
                    margin-top: 2.5%;
                    }

            .sidebar {
                height: 150%;
                width: 13%;
                position: fixed;
                top: 0;
                left: -150%; 
                background-color: #acc1e5;
                transition: 0.3s;

            }

            .sidebar a {
                padding: 7%;
                text-decoration: none;
                font-size: 1vw;
                color: #1c4b6a;
                display: block;
            }

            .sidebar img {
            width: 110%;
            height: auto;

            }

            .sidebar a:hover {
                background-color: #acc1e5;
            }


            .content {
                margin-left: 5%;
                padding: 7%;
            }

            .content a img {
                position: fixed;
                left: 1%;
                top: 2%;
                width: 10%;
                height: auto;
                z-index: 3;
                }

                body {
                background-image: url('/images/Fondo3.png');  
                background-size: cover;               

                margin: 0;
                padding: 0;
                overflow: hidden; 
                display: flex;
                flex-direction: column;
                min-height: 100vh;
                }

                main {
                display: flex;
                flex-direction: column;
                }

                header{
                    background-color: rgb(31, 39, 78);
                    color: white;
                    text-align: center;
                    padding: 0.5%;
                
                }

                footer {
                    background-color: rgb(31, 39, 78);
                    color: white;
                    text-align: center;
                    padding: 0.5%;
                    margin-top: auto;
                }
                    
                    
                .header-container {
                    display: flex;
                    align-items: center;
                    justify-content: space-between; 
                }

                .listaTareasEliminadas {
                    background-color: rgb(163, 186, 217);
                    width: 70%;
                    max-height: 60vh; 
                    overflow-y: auto; 
                    height: 60vh;
                    padding: 1.5%;
                    border: 1px solid #ccc;
                    position: fixed;
                    top: 60%;
                    left: 50%;
                    transform: translate(-50%, -50%); 
                    font-family: 'Arial', sans-serif; 
                    font-size: 1.5vw;
                    flex-direction: column;
                    display: flex;
                    
                }

                .listaTareasEliminadas li {
                    list-style-type: none;
                    display: flex;
                    flex-direction: row; 
                    align-items: center;
                    background-color: white;
                    border: 1px solid #ccc; 
                    padding: 0.5%;
                } 

                .flechavolver {
                width: 60%;
                position: fixed;
                display: flex;
                justify-content: center;
                align-items: center;
                top: 25%; 
                left: 26%; 
                transform: translate(-50%, -50%); 
                color: rgb(31, 39, 78);

                }

                .flechavolver img {
                width: 40%;
                height: auto;
                }

                .nombreUsuario1 {
                    font-size: 1.9vw;
                    text-align: right;
                    color: rgb(255, 255, 255);
                    font-family: 'Arial', sans-serif; 
                    background-color: rgb(31, 39, 78);
                    z-index: 10;
                    margin: 0;
                    }


                .cerrar {
                    position: fixed;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    top: 23%; 
                    left: 90%; 
                    transform: translate(-50%, -50%); 
                    color: rgb(31, 39, 78);

                    }

                    .cerrar img {
                    max-width: 80%;
                    height: auto;
                    }

                    
                .textoexplicativo {
                    color: rgb(255, 255, 255);
                    font-family: 'Arial', sans-serif; 
                    font-size: 1.8vw;
                    position: absolute;
                    top: 91%;
                    left: 21%;
                        
                }

                .textoexplicativo2 {
                    color: rgb(255, 255, 255);
                    font-family: 'Arial', sans-serif; 
                    font-size: 1.8vw;
                    position: absolute;
                    top: 94%;
                    left: 21%;
                        
                }

            }

                    
  </style>
  </head>
    
  <body>

    

    <header>
        <p class="nombreUsuario1">   Usuario conectado: <%= user.name %>  &nbsp;  &nbsp;</p>  
    </header>

    <main class="d-flex justify-content-between flex-row mb-3 flex-lg-row">

        <div class="p-2 ">    
            <div class="sidebaror " > 
                <div class="content" >
                    <a href="#" onclick="toggleSidebar()"><img src="/images/logo.png" alt="Botón de menú"></a>
                </div>
                <div class="sidebar" id="sidebar">
                    <p>&nbsp; &nbsp;</p>
                    <p>&nbsp; &nbsp;</p>
                    <p>&nbsp; &nbsp;</p>
                    <p>&nbsp; &nbsp;</p>
                    <a href="#" onclick="checklist()"><img src="/images/listaicono.png" alt="Icono Checklist"></a>
                    <a href="#" onclick="mascota()"><img src="/images/homeicono.png" alt="Icono Tienda"></a>
                    <a href="#" onclick="cementerio()"><img src="/images/Tumba.png" alt="Icono Cementerio"></a>
                </div>
            </div>           

      </div>

      <div class="p-2 ">   

        
        <ul class="listaTareasEliminadas" id="listaTareasEliminadas">
        </ul>     


        <div class="flechavolver" id="flechavolver">
            <a></a> <a></a>  <a></a> <a></a> <a></a> <a></a> <a></a> <a></a>
            <a href="#" onclick="flechavolver()"><img src="/images/Flecha.png" alt="IconoFlecha"></a>
        </div>
        <div class="cerrar" id="cerrar">
            <a></a> <a></a>  <a></a> <a></a> <a></a> <a></a> <a></a> <a></a>
            <a href="#" onclick="cerrar()"><img src="/images/cerrar.png" alt="IconoCerrar"></a>
        </div>

        <div class="textoexplicativo" id="textoexplicativo">Las tareas con fecha de hace un mes se borrarán automáticamente.</div>
        <div class="textoexplicativo2" id="textoexplicativo2">Las tareas restauradas ya no valdrán puntos.</div>
        
      </div>



      <div class="p-2 "> 
       
      </div>

                
    </main>

    <footer>
      
    </footer>






  <script>
           /*
       const nuevaTarea = {
        nombre: 'Nombre de la tarea',
        fechaVencimiento: new Date(), // Puedes ajustar la fecha según sea necesario
        puntos: 10,
        tipotarea: 'Tipo de tarea',
        };

        // Realizar una solicitud POST a la ruta /api/tareas
        fetch('/api/tareas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(nuevaTarea),
        })
        .then(response => response.json())
        .then(data => {
            // Manejar la respuesta recibida después de guardar la tarea
            console.log('Tarea guardada:', data);
            // Aquí puedes realizar cualquier otra operación después de guardar la tarea
        })
        .catch(error => console.error('Error al guardar la tarea:', error));

        fetch('/api/tareas')
        .then(response => response.json())
        .then(data => {
            // Manejar la lista de tareas recibida en 'data'
            console.log('Lista de tareas:', data);
            // Aquí puedes realizar cualquier otra operación con la lista de tareas
        })
        .catch(error => console.error('Error al obtener la lista de tareas:', error));

        const taskId = Obtén el id de alguna manera ;
        // Realizar una solicitud DELETE a la ruta /api/tareas/:id
        fetch(`/api/tareas/${taskId}`, {
        method: 'DELETE',
        })
        .then(response => response.json())
        .then(data => {
            // Manejar la respuesta recibida después de eliminar la tarea
            console.log('Tarea eliminada:', data);
            // Puedes realizar cualquier otra operación después de eliminar la tarea
        })
        .catch(error => console.error('Error al eliminar la tarea:', error));

      */
    

    
      var userId = '<%= user.id %>';
      
      function toggleSidebar() {
          var sidebar = document.getElementById('sidebar');
          if (sidebar.style.left === '0px') {
              sidebar.style.left = '-750px';
          } else {
              sidebar.style.left = '0px';
          }
      }

        
        //const tareasEliminadas = JSON.parse(localStorage.getItem('tareasEliminadas')) || []; ///
        let taskIdCounter = 0;
        const tareasEliminadasList = document.querySelector('.listaTareasEliminadas');

        /*
        const botonesRestaurar = document.querySelectorAll(".botonrestaurar");

        botonesRestaurar.forEach(boton => {
            boton.addEventListener('click', () => {
                console.log('Botón restaurar presionado');
                restaurarTarea(boton.parentElement.parentElement);
            });
        }); */

        

        function eliminarTareasAnterioresAUnMes() {                                                                         //ARREGLAR

         }

                /*
        function eliminarTarea(tareaRow) {
            const taskId = tareaRow.dataset.taskId;
            const tareas = JSON.parse(localStorage.getItem('tareas')) || []; //
            

            const tareaIndex = tareas.findIndex(task => task.id === parseInt(taskId));
            if (tareaIndex !== -1) {
                tareasEliminadas.push(tareas[tareaIndex]);
                tareas.splice(tareaIndex, 1);

                localStorage.setItem('tareas', JSON.stringify(tareas));  ///
                localStorage.setItem('tareasEliminadas', JSON.stringify(tareasEliminadas)); ///
            }
            tareaRow.remove();
        }  */

      
        const fechaActual = new Date();
        //const tareasEliminadas = JSON.parse(localStorage.getItem('tareasEliminadas')) || [];
        fetch('/' + userId +'/papeleras')
        .then(response => response.json())
        .then(data => {
            data.forEach(tarea => {
            if (tarea.fechaVencimiento) {
                        // Crear un objeto Date con la fecha de vencimiento
                        const fechaVencimiento = new Date(tarea.fechaVencimiento);
                        const diferenciaEnMilisegundos = fechaVencimiento - fechaActual;
                        const diferenciaEnDias = Math.floor(diferenciaEnMilisegundos / (1000 * 60 * 60 * 24));
                        


                        if (diferenciaEnDias > 30) {
                            fetch('/' + userId +`/papeleras/${tarea._id}`, {
                                method: 'DELETE',
                                })
                                .then(response => response.json())
                                .then(data => {
                                console.log('Tarea eliminada:', data);
                                })
                                .catch(error => console.error('Error al eliminar la tarea:', error));
 
                            return; 
                        }

                        // Obtener los componentes de la fecha
                        const año = fechaVencimiento.getFullYear();
                        const mes = ('0' + (fechaVencimiento.getMonth() + 1)).slice(-2);
                        const día = ('0' + fechaVencimiento.getDate()).slice(-2);
                        tarea.fechaVencimiento = `${año}-${mes}-${día}`;
            }

            const tareaItem = document.createElement('li');
            tareaItem.innerHTML = `
                <div class="col"> <label for="tarea1">${tarea.nombre}</label></div>
                <div class="col-2">${tarea.fechaVencimiento}</div>
                <div class="col-1">${tarea.puntos}</div>
                <div class="col-3">${tarea.tipotarea}</div>
                <div class="col-3"><button class="botonrestaurar">Restaurar</button></div>
            `;
            tareasEliminadasList.appendChild(tareaItem);

                    // Obtén una lista de todos los botones "Restaurar"
        const botonesRestaurar = tareaItem.querySelectorAll('.botonrestaurar');

        // Agrega un controlador de eventos a cada botón "Restaurar"
        botonesRestaurar.forEach(boton => {
                boton.addEventListener('click', () => {  
                    

                    var userId = '<%= user.id %>'; 

                    fetch('/' + userId + '/tareas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(tarea),
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Tarea guardada:', data);
                    })
                    .catch(error => console.error('Error al guardar la tarea:', error));

   
                    const taskId = tarea._id;

                    fetch('/' + userId +`/papeleras/${taskId}`, {
                    method: 'DELETE',
                    })
                    .then(response => response.json())
                    .then(data => {
                    console.log('Tarea eliminada:', data);
                    })
                    .catch(error => console.error('Error al eliminar la tarea:', error));

                

                var userId = '<%= user.id %>';
                window.location.href = "/checklist/" + userId;

                    
                });
            });


        });
        })
        .catch(error => console.error('Error al obtener la lista de tareas:', error));
        



        function compareDates(dateStringA, dateStringB) {
            
            const dateA = new Date(dateStringA);
            const dateB = new Date(dateStringB);
            return dateA - dateB;
        }

        function ordenarTareasPorFecha() {
            const listaTareas = document.querySelector('.listaTareasEliminadas');
            const tareas = Array.from(listaTareas.querySelectorAll('li'));

            tareas.sort((a, b) => {
                const fechaA = a.querySelector('.col-2').textContent;
                const fechaB = b.querySelector('.col-2').textContent;
                return compareDates(fechaA, fechaB);
            });

            while (listaTareas.firstChild) {
                listaTareas.removeChild(listaTareas.firstChild);
            }

            tareas.forEach(tarea => {
                listaTareas.appendChild(tarea);
            });
        }

        eliminarTareasAnterioresAUnMes();
        ordenarTareasPorFecha();
</script>



<script>
    function index(){
        var userId = '<%= user.id %>';
        window.location.href = "/"  + userId;

    }

    function flechavolver(){
        var userId = '<%= user.id %>';
        window.location.href = "/checklist/" + userId;

    }

    function mascota(){
        var userId = '<%= user.id %>';
      window.location.href = "/mascota/" + userId;

    }
    function cerrar(){
        var userId = '<%= user.id %>';
        window.location.href = "/"  + userId;

    }
    function cementerio(){
        var userId = '<%= user.id %>';
      window.location.href = "/cementerio/" + userId;

    }

</script>
    <script src="/bootstrap-datepicker-master/dist/js/bootstrap-datepicker.js"></script>

    <!--  <h1>Hello, world!</h1> -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  </body>
</html>