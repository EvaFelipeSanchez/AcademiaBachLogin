<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AcademiaBach</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <style>


            .store {

            overflow-y: auto; 
            color: #000;
            font-family:  sans-serif; 
            }

            .item {
            background-color: #acc1e5;
            border: 1px solid #1b184f;
            text-align: center;
            color: #000;
          
            }



        .activar-button {
            background-color: #213953;
            color: #fff;
            border: none;
            cursor: pointer;
        }


        

 

  </style>
  </head>
    

  <body>
	<div class="d-flex flex-row min-vh-100">
		<div class="offcanvas offcanvas-start w-auto" id="navbarSupportedContent" style="background-color: #acc1e5;">
			<div class="offcanvas-header">
				<button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
			</div>

			<div class="offcanvas-body">
				<ul class="nav flex-column">
					<li class="nav-item">
						<a class="nav-link" aria-current="page" href="#" style="text-align:center" onclick="index()">
							<img src="/images/indexlogo.png" style="width: 100px;" >
						</a>
					</li>
                    <li class="nav-item">
						<a class="nav-link" aria-current="page" href="#" style="text-align:center" onclick="checklist()">
							<img src="/images/listaicono.png" style="width: 100px;" >
						</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" aria-current="page" href="#" style="text-align:center" onclick="papelera()">
							<img src="/images/papeleralogo.png" style="width: 100px;">
						</a>
					</li>

					<li class="nav-item">
						<a class="nav-link" aria-current="page" href="#" style="text-align:center" onclick="tienda()">
							<img src="/images/tiendalogo.png" style="width: 100px;">
						</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" aria-current="page" href="#" style="text-align:center" onclick="cementerio()">
							<img src="/images/Tumba.png" style="width: 100px;">
						</a>
					</li>
				</ul>
			</div>
		</div>

		<div class="offcanvas offcanvas-top" id="navbarSupportedContentTop" style="background-color: #acc1e5;">
			<div class="offcanvas-header">
				<button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
			</div>
			<div class="offcanvas-body" >
				<ul class="nav flex-row">
                    <li class="nav-item" style="margin-right: -2%;">
						<a class="nav-link" aria-current="page" href="#" style="text-align:center" onclick="index()">
							<img src="/images/indexlogo.png" style="width: 55px;">
    
						</a>
					</li>
                    <li class="nav-item" style="margin-right: -2%;">
                        <a class="nav-link" aria-current="page" href="#" style="text-align:center" onclick="checklist()">
                            <img src="/images/listaicono.png" style="width: 55px;">
            
                        </a>
                    </li>
					<li class="nav-item" style="margin-right: -2%;">
						<a class="nav-link" aria-current="page" href="#"  style="text-align:center" onclick="papelera()">
							<img src="/images/papeleralogo.png" style="width: 55px;">
                
						</a>
					</li>
            

                <li class="nav-item" style="margin-right: -2%;">
                    <a class="nav-link" aria-current="page" href="#" style="text-align:center" onclick="tienda()">
                        <img src="/images/tiendalogo.png" style="width: 55px;">
     
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" aria-current="page" href="#" style="text-align:center" onclick="cementerio()">
                        <img src="/images/Tumba.png" style="width: 60px;">
          
                    </a>
                </li>
				</ul>
			</div>
		</div>

        <div class="flex-grow-1 d-flex flex-lg-row flex-column" style="border:1px SOLID black;">
            <div class="p-2  flex-grow-1 d-flex flex-column  justify-content-start align-items-stretch"
                style="background-color:rgb(82,107,141); color:white">

				<div class="d-flex flex-row justify-content-between" style="width:100%;">
					<a type="button" data-bs-toggle="offcanvas" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" class="d-none d-lg-block">
						<img src="/images/logo.png" style="width: 100px;">
					</a>

					<a type="button" data-bs-toggle="offcanvas" data-bs-target="#navbarSupportedContentTop" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" class="d-lg-none">
						<img src="/images/logo.png" style="width: 80px;">
					</a>

				</div>

                <div class="container" style="margin-bottom: 50px;">
                    <div class="store row ">

                   </div>
                </div> 

                 <!--
                <div  style="position: absolute; bottom: 0; width: 100%;  background-color: rgb(31, 39, 78); color: white; padding: 1%; text-align: center;">
                    <h3 class="display-15" style="text-align:center" >Puntos: <h id="puntosTotales">00</h></h3>
                </div>
                -->

                <div  id="avisovacio">
                    <div style="background-color: rgb(31, 39, 78); color:white;" class="avisovacio d-flex flex-column align-items-center p-3" >
                        <h3  class="display-3 text-center" >Lista de mascotas vacía</h3>
                        <h3  class="display-3 text-center" >Compra una mascota en la tienda</h3>
                        <a class="nav-link" aria-current="page" href="#" style="text-align:center" onclick="tienda()">
                            <img src="/images/tiendalogo.png" style="width: 100px;">
                        </a>
                    </div>
                </div> 
               

  
               
                
			</div>
            

		</div>



    </div>




<script>
        // Obtener la tienda (div con clase "store")
        var store = document.querySelector('.store');

        // Obtener todos los elementos con clase "item" dentro de la tienda
        var items = store.querySelectorAll('.item');
        var userId = '<%= user.id %>';

		//var avisovacio = document.querySelector(".avisovacio");
        //var avisovacio = document.getElementById('avisovacio');
        var avisovacioContainer = document.getElementById('avisovacio');

		//avisovacio.style.display = 'none';

        function ocultarContenido() {
            avisovacioContainer.innerHTML = '';
        }


        function mostrarContenido() {
            avisovacioContainer.innerHTML = `
                <div style="background-color: rgb(31, 39, 78); color:white;" class="avisovacio d-flex flex-column align-items-center p-3">
                    <h3 class="display-3 text-center">Lista de mascotas vacía</h3>
                    <h3 class="display-3 text-center">Compra una mascota en la tienda</h3>
                    <a class="nav-link" aria-current="page" href="#" style="text-align:center" onclick="tienda()">
                        <img src="/images/tiendalogo.png" style="width: 100px;">
                    </a>
                </div>
            `;
        }
        

        fetch('/' + userId +'/mascotas')
        .then(response => response.json())
        .then(data => {
            console.log('Lista de mascotas:', data);

           /*
            if (data.length === 0) {
               // avisovacio.style.display = 'block';
            }else{
                avisovacio.style.display = 'none';
            } */

            if (data.length === 0) {
                mostrarContenido();
            }else{
                ocultarContenido();
            }
            

        //var listaLocal = JSON.parse(localStorage.getItem('storeElements')) || [];
        //var listaLocal = [];
        //localStorage.setItem('storeElements', JSON.stringify(listaLocal));


        // col-xl-3 col-lg-4 col-md-6 col-12 
        if (data.length === 0) {

            items.forEach(function (item, index) {
            var imagen = item.querySelector('img').src;
            var segundaImagen = item.querySelector('.segunda-imagen').src;
            var nombre = item.querySelector('.nombre').textContent;

            var elementoTienda = {
                userId: userId,
                nombre: nombre,
                imagenPrincipal: imagen,
                segundaImagen: segundaImagen,
                
            };  


            
            fetch('/' + userId + '/mascotas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(elementoTienda),
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Tarea guardada:', data);
                    })
                    .catch(error => console.error('Error al guardar la tarea:', error));


            /*
            if (!localStorage.getItem('funcionEjecutada')) { ///
            window.onload = function() {
                window.location.href = "tienda.ejs";
                localStorage.setItem('funcionEjecutada', 'true');
            };
            }  */

            //listaLocal.push(elementoTienda);
        });

        } 
        })
        .catch(error => console.error('Error al obtener la lista de tareas:', error));

        //var storeElements = JSON.parse(localStorage.getItem('storeElements')) || [];

       // window.onload = function() {

        
            function elementYaExisteEnMascota(elementData) {
                var storeContainer = document.querySelector('.store');
                var items = storeContainer.querySelectorAll('.item');

                for (var i = 0; i < items.length; i++) {
                    var nombreElement = items[i].querySelector('.nombre');
                    if (nombreElement.textContent === elementData.nombre) {
                        return true; // El elemento ya existe en la ventana "mascota.html"
                    }
                }

                return false; // El elemento no existe en la ventana "mascota.html"
            }


        //function cargarElementosGuardados() {
            var storeContainer = document.querySelector('.store');
           // var listaLocal = JSON.parse(localStorage.getItem('storeElements')) || []; //
            storeContainer.innerHTML = '';

            fetch('/' + userId +'/mascotas')
            .then(response => response.json())
            .then(data => {
                // Manejar la lista de tareas recibida en 'data'
                console.log('Lista de mascotas', data);
                data.forEach(function (elementData) {

                    if (!elementYaExisteEnMascota(elementData)) {
                        var nuevoItem = document.createElement('div');
                        nuevoItem.classList.add('item', 'col-xl-3', 'col-lg-4', 'col-md-6', 'col-12');
                        var nuevoItem = document.createElement('div');
                        nuevoItem.classList.add('item', 'col-xl-3', 'col-lg-4', 'col-md-6', 'col-12');

                        var nuevaImagen = document.createElement('img');
                        nuevaImagen.src = elementData.imagenPrincipal;
                        nuevaImagen.alt = 'Nuevo Producto';
                        nuevoItem.appendChild(nuevaImagen);

                        var nuevaSegundaImagen = document.createElement('img');
                        nuevaSegundaImagen.src = elementData.segundaImagen;
                        nuevaSegundaImagen.alt = 'Nuevo Producto-2';
                        nuevaSegundaImagen.classList.add('segunda-imagen');
                        nuevaSegundaImagen.style.display = 'none';
                        nuevoItem.appendChild(nuevaSegundaImagen);

                        var nuevoNombre = document.createElement('p');
                        nuevoNombre.classList.add('nombre');
                        nuevoNombre.textContent = elementData.nombre;
                        nuevoItem.appendChild(nuevoNombre);

                        var nuevoBotonActivar = document.createElement('button');
                        nuevoBotonActivar.classList.add('activar-button');
                        nuevoBotonActivar.textContent = 'Asignar';
                        nuevoBotonActivar.onclick = function () {
                                console.log(elementData.nombre);
                                
                                console.log("Lista encontrada: " + elementData.nombre);
                                let userId = '<%= user.id %>' || '';
                                var imagenPrincipal = elementData.imagenPrincipal;
                                var segundaImagen = elementData.segundaImagen;
                                var nombre = elementData.nombre;
                                
                                
                                if (!userId) {
                                        throw new Error('No se encontró un ID en los datos del usuario');
                                }

     
                                    
                                fetch(`/${userId}/mascotaprincipal`)
                                        .then(response => {
                                            if (!response.ok) {
                                            throw new Error(`Error del servidor: ${response.status} - ${response.statusText}`);
                                            }
                                            return response.json();
                                        })
                                        .then(data => {
                                            let idPrincipal =data[0]._id;
                                            const dataToUpdate = {
                                                userId: userId,
                                                nombrePrincipal: nombre, 
                                                imagenPrincipal: imagenPrincipal,
                                                segundaImagen: segundaImagen
                                            };
                                            console.log("Nombre principal:" + dataToUpdate.userId);
                                                console.log("Nombre principal:" + dataToUpdate.nombrePrincipal); //Entrega el nombre correcto
                                                console.log("Id principal:" + idPrincipal); //Entrega el dato correcto
                                                console.log("Imagen principal:" + dataToUpdate.imagenPrincipal); 
                                                

                                            fetch(`/${userId}/mascotaprincipal/${idPrincipal}`, {
                                                method: 'PUT',
                                                headers: {
                                                    'Content-Type': 'application/json',
                                                },
                                                body: JSON.stringify(dataToUpdate),
                                                })
                                                .then(response => {
                                                    if (!response.ok) {
                                                    throw new Error(`Error del servidor: ${response.status} - ${response.statusText}`);
                                                    }
                                                    return response.json();
                                                })
                                                .then(updatedData => {
                                                    // Manipula los datos actualizados, por ejemplo, imprime en la consola.
                                                    console.log('Datos actualizados de mascota principal:', updatedData);
                                                })
                                                .catch(error => {
                                                    console.error('Error al realizar la solicitud:', error);
                                                });

                                                
                                                fetch(`/${userId}/displayValue`)
                                                .then(response => response.json())
                                                .then(datap => {
                                                    let iddisplayValue = datap[0]._id;
                                                    let userId = '<%= user.id %>';

                    
                                                        const dataToUpdate = {
                                                            userId: userId,
                                                            displayValue: "none" ,
                                                        };


                                                        fetch(`/${userId}/displayValue/${iddisplayValue}`, {
                                                                    method: 'PUT',
                                                                    headers: {
                                                                        'Content-Type': 'application/json',
                                                                    },
                                                                    body: JSON.stringify(dataToUpdate),
                                                                    })
                                                                    .then(response => {
                                                                        if (!response.ok) {
                                                                        throw new Error(`Error del servidor: ${response.status} - ${response.statusText}`);
                                                                        }
                                                                        return response.json();
                                                                    })
                                                                    .then(updatedData => {
                                                                        console.log('Response JSON:', updatedData);
                                                                        // Handle the updated data as needed
                                                                    })
                                                                    .catch(error => {
                                                                        console.error('Error al realizar la solicitud:', error);
                                                                    }); 
                                                                    
                                                                    window.location.href = "/"  + userId;
                                                    
                                                })
                                                .catch(error => console.error('Error al obtener la lista de tareas:', error));
                                                
                                         
                                        })
                                        .catch(error => {
                                            console.error('Error al realizar la solicitud:', error);
                                        });



                  
                
                          
                        };
                        nuevoItem.appendChild(nuevoBotonActivar);

                        storeContainer.appendChild(nuevoItem);
              
                    }
  
            });

            })
            .catch(error => console.error('Error al obtener la lista de tareas:', error));

         

        



   


    


</script>


<script>

         function index(){
                var userId = '<%= user.id %>';
                window.location.href = "/"  + userId;
        
        }

         function checklist(){
        var userId = '<%= user.id %>';
        window.location.href = "/checklist/" + userId;

        }
	 
	 
		 function papelera(){
			 var userId = '<%= user.id %>';
			 window.location.href = "/papelera/" + userId;
	 
		 }
	 
	 
		 function cementerio(){
			 var userId = '<%= user.id %>';
		   window.location.href = "/cementerio/" + userId;
	 
		 }

		 function tienda(){
        var userId = '<%= user.id %>';
        window.location.href = "/tienda/" + userId;
        }		 
	


</script>

    <!--  <h1>Hello, world!</h1> -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  </body>
</html>